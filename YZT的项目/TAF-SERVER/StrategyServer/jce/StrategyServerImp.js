// **********************************************************************
// This file was generated by a TAF parser!
// TAF version 4.2.2 by TAF Team.
// Generated from `./StrategyServer.jce'
// **********************************************************************
var Q = require('q');
var logger = require('../lib/log');
var util   = require('../lib/util');
var config = util.getConf();
var common   = require('../lib/common');
var TafStream = require('@taf/taf-stream');
var Strategy = require('./StrategyServer.js').Strategy;
module.exports.Strategy = Strategy;
var Taf = require("@taf/taf-rpc").Communicator.New();
var Common_HQSys = require("./CommonJce.js").HQSys;
var BasicData_HQSys = require("./BasicDataJce.js").HQSys;
var HQSys = require("./HsServerProxy.js").HQSys;
var servant = 'HQWeb.HsServer.HsServerObj';
if (!process.env.TAF_CONFIG) {
    //servant += "@tcp -h 127.0.0.1 -p 14009 -t 60000";
    servant += "@tcp -h 172.16.8.146 -t 60000 -p 10022";
}

var prx = Taf.stringToProxy(HQSys.BasicHqProxy, servant);



Strategy.StrategyInterfImp.prototype.initialize = function ( ) {

}

Strategy.StrategyInterfImp.prototype.getChooseStock = function (current, chooseStockReq, chooseStockRsp) {
    logger.stgyserver.info('-------------->Execute getChooseStock');
    var chooseStockRsp = new Strategy.ChooseStockRsp();
    try{
        if(!chooseStockReq){
            logger.stgyserver.info('getChooseStock no request param');
            chooseStockRsp.iRet=-1;
            chooseStockRsp.iMsg='缺少请求参数';
            current.sendResponse(-1, chooseStockRsp);
            return;
        }
        var key=chooseStockReq.stgyCode+'_'+chooseStockReq.chooseDate;
        var chooseStockMap = global.ChooseStock;
        if(chooseStockMap===undefined){
            logger.stgyserver.info('getChooseStock no data');
            chooseStockRsp.iRet=0;
            chooseStockRsp.iMsg='请求无数据';
            current.sendResponse(0, chooseStockRsp);
            return;
        }
        var chooseStockList = chooseStockMap[key];
        var stockArray =[];
        if(chooseStockList!=undefined){
            var chooseStockListJson = JSON.parse(chooseStockList);
            chooseStockListJson.forEach(stock=>{
                var stockCode = stock.gpcode.substr(2,stock.gpcode.length);
                var market =stock.gpcode.substr(0,2)=='SH'?1:0;
                var jsonObj = {
                    stockCode:stockCode,
                    stockName:stock.gpName,
                    market:market,
                    price:stock.Price,
                    maxRise:stock.MaxRise,
                    dayRise:stock.Rise_SignalDate
                }
                stockArray.push(jsonObj);
            });
        }
        chooseStockRsp.iRet=0;
        chooseStockRsp.iMsg='SUCCESS';
        chooseStockRsp.chooseStockList.readFromObject(stockArray);
        current.sendResponse(0, chooseStockRsp);
        return;
    }catch(e){
        logger.stgyserver.info('getChooseStock exception',e);
        chooseStockRsp.iRet=-100;
        chooseStockRsp.iMsg='请求异常';
        current.sendResponse(-100, chooseStockRsp);
        return;
    }

}

Strategy.StrategyInterfImp.prototype.getOptiStock = function (current, optiStockRsp) {
    logger.stgyserver.info('-------------->Execute getOptiStock');
    var optiStockRsp = new Strategy.OptiStockRsp();
    try{
        var optiStgyStockList = global.OptiStgyStock;
        if(optiStgyStockList===undefined){
            logger.stgyserver.info('getOptiStock no data');
            optiStockRsp.iRet=0;
            optiStockRsp.iMsg='请求无数据';
            current.sendResponse(0, optiStockRsp);
            return;
        }
        var stockArray=[];
        optiStgyStockList.forEach(stock=>{
            var stockCode = stock.gpcode.substr(2,stock.gpcode.length);
            var market =stock.gpcode.substr(0,2)=='SH'?1:0;
            var jsonObj = {
                stockCode:stockCode,
                stockName:stock.name,
                market:market,
                chooseDate:stock.Buy_Date,
                flag:stock.Flag,
                highIncrease:stock.Highest_Increase,
                nextIncrease:stock.Next_Increase,
                fiveDayIncrease:stock.Five_Day_Highest_Increase,
                tenDayIncrease:stock.Ten_Day_Highest_Increase
            }
            stockArray.push(jsonObj);
        });
        optiStockRsp.iRet=0;
        optiStockRsp.iMsg='SUCCESS';
        optiStockRsp.optiStockList.readFromObject(stockArray);
        current.sendResponse(0, optiStockRsp);
        return;
    }catch(e){
        logger.stgyserver.info('getOptiStock exception',e);
        optiStockRsp.iRet=-100;
        optiStockRsp.iMsg='请求异常';
        current.sendResponse(-100, optiStockRsp);
        return;
    }
}

Strategy.StrategyInterfImp.prototype.getPerfectStock = function (current, topStockRsp) {
    logger.stgyserver.info('-------------->Execute getPerfectStock');
    var topStockRsp = new Strategy.TopStockRsp();
    try{
        var topStockList= global.GoldStockPool;
        if(topStockList===undefined){
            logger.stgyserver.info('getPerfectStock no data');
            topStockRsp.iRet=0;
            topStockRsp.iMsg='请求无数据';
            current.sendResponse(0, topStockRsp);
            return;
        }
        var stockArray = [];
        topStockList.forEach(stock=>{
            var stockCode = stock.gpcode.substr(2,stock.gpcode.length);
            var market =stock.gpcode.substr(0,2)=='SH'?1:0;
            var os =stock.OS;
            var gsName=stock.gsName_yzt;
            //var gsName=stock.gsName;
            //var gsName_Phone=stock.gsName_Phone;
            //if(os==2&&gsName_Phone!=null){
            //    gsName =gsName_Phone;
            //}
            var recommend=config.stgycategory.recommend;
            var limitup=config.stgycategory.limitup;
            var leading=config.stgycategory.leading;
            var stgyCategory =Strategy.StgyCategory.Recommend
            if(recommend.indexOf(stock.gscode)>=0){
                stgyCategory=Strategy.StgyCategory.Recommend;
            }else if(limitup.indexOf(stock.gscode)>=0){
                stgyCategory=Strategy.StgyCategory.LimitUp;
            }else if(leading.indexOf(stock.gscode)>=0){
                stgyCategory=Strategy.StgyCategory.Leading;
            }
            var jsonObj = {
                stockCode:stockCode,
                stockName:stock.gpName,
                market:market,
                chooseDate:stock.Date,
                maxRise:stock.MaxRise,
                nextDayRise:stock.Rise_NextDay,
                stgyCode:stock.gscode,
                stgyName:gsName,
                price:stock.Price,
                stgyCategory:stgyCategory
            }
            stockArray.push(jsonObj);
        });
        topStockRsp.iRet=0;
        topStockRsp.iMsg='SUCCESS';
        topStockRsp.topStockList.readFromObject(stockArray);
        current.sendResponse(0, topStockRsp);
        return;
    }catch(e){
        logger.stgyserver.info('getPerfectStock exception',e);
        topStockRsp.iRet=-100;
        topStockRsp.iMsg='请求异常';
        current.sendResponse(-100, topStockRsp);
        return;
    }
}

Strategy.StrategyInterfImp.prototype.getStgyInfoList = function (current, stgyCategory, stgyInfoRsp) {
    logger.stgyserver.info('-------------->Execute getStgyInfoList');
    var stgyInfoRsp = new Strategy.StgyInfoRsp();
    try{
        if(!stgyCategory){
            logger.stgyserver.info('getStgyInfoList no request param');
            stgyInfoRsp.iRet=-1;
            stgyInfoRsp.iMsg='缺少请求参数';
            current.sendResponse(-1, stgyInfoRsp);
            return;
        }
        var stgyInfoMap= global.StgyInfoMap;
        if(stgyInfoMap===undefined){
            logger.stgyserver.info('getStgyInfoList no data');
            stgyInfoRsp.iRet=0;
            stgyInfoRsp.iMsg='请求无数据';
            current.sendResponse(0, stgyInfoRsp);
            return;
        }
        var stgyInfoList=  stgyInfoMap['STGYINFO_'+stgyCategory];
        var stgyArray = [];
        if(stgyInfoList!=undefined){
            stgyInfoList.forEach(stgyInfo=>{
                var  beginCalcDate= stgyInfo.Date_BeginCalc+'';
                var  endCalcDate =stgyInfo.Date_StopCalc+'';
                var  winLine=+stgyInfo.StopWinLine;
                var  lossLine=+stgyInfo.StopLossLine;
                var  loopBack=+stgyInfo.CutRate;
                var reviewDesc='以'+common.formatStrDate(beginCalcDate)+'至'+common.formatStrDate(endCalcDate)+'之间的选股结果为评测样本，' +
                    '假设每天按照策略推荐买入全部股票，当收益超过'+(winLine*100).toFixed(2)+'%'+'时继续持有，直至回撤'+(loopBack*100).toFixed(2)+'%'+'时止盈；' +
                    '当亏损超过'+(lossLine*100).toFixed(2)+'%'+'时立即止损，可得到不同持股天数对应的平均涨幅和胜率。';
                var os =stgyInfo.OS;


                var gsName=stgyInfo.gsName_yzt;
                //var gsName=stgyInfo.gsName;
                //var gsName_Phone=stgyInfo.gsName_Phone;
                //if(os==2&&gsName_Phone!=null){
                //    gsName =gsName_Phone;
                //}
                var pic_url = config.pic.pic_url;
                var jsonObj = {
                    stgyCode:stgyInfo.gscode,
                    stgyName:gsName,
                    stgyStyle:stgyInfo.gsStyle,
                    instruction:stgyInfo.gsInstruction,
                    creator:stgyInfo.gsCreator,
                    winLine:stgyInfo.StopWinLine,
                    lossLine:stgyInfo.StopLossLine,
                    stgyVane:stgyInfo.gsMarket,
                    maxRise:stgyInfo.gsMaxRise,
                    maxRiseWinRate:stgyInfo.WinRate_gsMaxRise,
                    maxRiseHolder:stgyInfo.DayNum_gsMaxRise,
                    winRate:stgyInfo.gsMaxWinRate,
                    winRateMaxRise:stgyInfo.Rise_gsMaxWinRate,
                    winRateHolder:stgyInfo.DayNum_gsMaxWinRate,
                    beginCalcDate:stgyInfo.Date_BeginCalc,
                    endCalcDate:stgyInfo.Date_StopCalc,
                    newChooseDate:stgyInfo.NewDate,
                    newChooseNum:stgyInfo.gpNum_NewDate,
                    loopBack:stgyInfo.CutRate,
                    reviewDesc:reviewDesc,
                    pic:pic_url+stgyInfo.gsPicture_yzt,
                    instruction_new:stgyInfo.gsInstruction_yzt
                }
                stgyArray.push(jsonObj);
            });
        }
        stgyInfoRsp.iRet=0;
        stgyInfoRsp.iMsg='SUCCESS';
        stgyInfoRsp.stgyInfoList.readFromObject(stgyArray);
        current.sendResponse(0, stgyInfoRsp);
        return;
    }catch(e){
        logger.stgyserver.info('getStgyInfoList exception',e);
        stgyInfoRsp.iRet=-100;
        stgyInfoRsp.iMsg='请求异常';
        current.sendResponse(-100, stgyInfoRsp);
        return;
    }

}

Strategy.StrategyInterfImp.prototype.getTopStgyInfoList = function (current, stgyInfoRsp) {
    logger.stgyserver.info('-------------->Execute getTopStgyInfoList');
    var stgyInfoRsp = new Strategy.StgyInfoRsp();
    try{
        var topStgyInfoList= global.TopStgyInfo;
        if(topStgyInfoList===undefined||topStgyInfoList.length==0){
            logger.stgyserver.info('getTopStgyInfoList no data');
            stgyInfoRsp.iRet=0;
            stgyInfoRsp.iMsg='请求无数据';
            current.sendResponse(0, stgyInfoRsp);
            return;
        }
        var stgyArray = [];
        topStgyInfoList.forEach(stgyInfo=>{
            var  beginCalcDate= stgyInfo.Date_BeginCalc+'';
            var  endCalcDate =stgyInfo.Date_StopCalc+'';
            var  winLine=+stgyInfo.StopWinLine;
            var  lossLine=+stgyInfo.StopLossLine;
            var  loopBack=+stgyInfo.CutRate;
            var reviewDesc='以'+common.formatStrDate(beginCalcDate)+'至'+common.formatStrDate(endCalcDate)+'之间的选股结果为评测样本，' +
                '假设每天按照策略推荐买入全部股票，当收益超过'+(winLine*100).toFixed(2)+'%'+'时继续持有，直至回撤'+(loopBack*100).toFixed(2)+'%'+'时止盈；' +
                '当亏损超过'+(lossLine*100).toFixed(2)+'%'+'时立即止损，可得到不同持股天数对应的平均涨幅和胜率。';
            var os =stgyInfo.OS;

            var gsName=stgyInfo.gsName_yzt;
            //var gsName=stgyInfo.gsName;
            //var gsName_Phone=stgyInfo.gsName_Phone;
            //if(os==2&&gsName_Phone!=null){
            //    gsName =gsName_Phone;
            //}
            var recommend=config.stgycategory.recommend;
            var limitup=config.stgycategory.limitup;
            var leading=config.stgycategory.leading;
            var stgyCategory =Strategy.StgyCategory.Recommend
            if(recommend.indexOf(stgyInfo.gscode)>=0){
                stgyCategory=Strategy.StgyCategory.Recommend;
            }else if(limitup.indexOf(stgyInfo.gscode)>=0){
                stgyCategory=Strategy.StgyCategory.LimitUp;
            }else if(leading.indexOf(stgyInfo.gscode)>=0){
                stgyCategory=Strategy.StgyCategory.Leading;
            }

            var jsonObj = {
                stgyCode:stgyInfo.gscode,
                stgyName:gsName,
                stgyStyle:stgyInfo.gsStyle,
                instruction:stgyInfo.gsInstruction,
                creator:stgyInfo.gsCreator,
                winLine:stgyInfo.StopWinLine,
                lossLine:stgyInfo.StopLossLine,
                stgyVane:stgyInfo.gsMarket,
                maxRise:stgyInfo.gsMaxRise,
                maxRiseWinRate:stgyInfo.WinRate_gsMaxRise,
                maxRiseHolder:stgyInfo.DayNum_gsMaxRise,
                winRate:stgyInfo.gsMaxWinRate,
                winRateMaxRise:stgyInfo.Rise_gsMaxWinRate,
                winRateHolder:stgyInfo.DayNum_gsMaxWinRate,
                beginCalcDate:stgyInfo.Date_BeginCalc,
                endCalcDate:stgyInfo.Date_StopCalc,
                newChooseDate:stgyInfo.NewDate,
                newChooseNum:stgyInfo.gpNum_NewDate,
                loopBack:stgyInfo.CutRate,
                reviewDesc:reviewDesc,
                pic:stgyInfo.gsPicture_yzt,
                instruction_new:stgyInfo.gsInstruction_yzt,
                stgyCategory:stgyCategory
            }
            stgyArray.push(jsonObj);
        });
        stgyInfoRsp.iRet=0;
        stgyInfoRsp.iMsg='SUCCESS';
        stgyInfoRsp.stgyInfoList.readFromObject(stgyArray);
        current.sendResponse(0, stgyInfoRsp);
        return;
    }catch(e){
        logger.stgyserver.info('getTopStgyInfoList exception',e);
        stgyInfoRsp.iRet=-100;
        stgyInfoRsp.iMsg='请求异常';
        current.sendResponse(-100, stgyInfoRsp);
        return;
    }

}

Strategy.StrategyInterfImp.prototype.getTopStock = function (current,stgyCode, topStockRsp) {
    logger.stgyserver.info('-------------->Execute getTopStock');
    var topStockRsp = new Strategy.TopStockRsp();
    try{
        if(!stgyCode){
            logger.stgyserver.info('getTopStock no request param');
            topStockRsp.iRet=-1;
            topStockRsp.iMsg='缺少请求参数';
            current.sendResponse(-1, topStockRsp);
            return;
        }
        var topStgyStockMap= global.TopStgyStock;
        if(topStgyStockMap===undefined){
            logger.stgyserver.info('getTopStgyStock no data');
            topStockRsp.iRet=0;
            topStockRsp.iMsg='请求无数据';
            current.sendResponse(0, topStockRsp);
            return;
        }
        var topStgyStockList = topStgyStockMap[stgyCode];
        var stockArray =[];
        if(topStgyStockList!=undefined){
            topStgyStockList.forEach(stock=>{
                var stockCode = stock.gpcode.substr(2,stock.gpcode.length);
                var market =stock.gpcode.substr(0,2)=='SH'?1:0;
                var jsonObj = {
                    stockCode:stockCode,
                    stockName:stock.gpName,
                    market:market,
                    chooseDate:stock.Date,
                    maxRise:stock.MaxRise,
                    nextDayRise:stock.Rise_NextDay
                }
                stockArray.push(jsonObj);
            });
        }
        topStockRsp.iRet=0;
        topStockRsp.iMsg='SUCCESS';
        topStockRsp.topStockList.readFromObject(stockArray);
        current.sendResponse(0, topStockRsp);
        return;
    }catch(e){
        logger.stgyserver.info('getTopStock exception',e);
        topStockRsp.iRet=-100;
        topStockRsp.iMsg='请求异常';
        current.sendResponse(-100, topStockRsp);
        return;
    }
}


Strategy.StrategyInterfImp.prototype.getStockStar = function (current, stReq, stRsp) {
    logger.stgyserver.info('-------------->Execute getStockStar');
    var stockStarRsp = new Strategy.StockStarRsp();
    try{
        if(!stReq){
            logger.stgyserver.info('getStockStar no request param');
            stockStarRsp.iRet=-1;
            stockStarRsp.iMsg='缺少请求参数';
            current.sendResponse(-1, stockStarRsp);
            return;
        }
        var stockStarArray= global.StockStar;
        if(stockStarArray===undefined){
            logger.stgyserver.info('getStockStar no data');
            stockStarRsp.iRet=0;
            stockStarRsp.iMsg='请求无数据';
            current.sendResponse(0, stockStarRsp);
            return;
        }
        var req_array = [];
        var starLevelMap ={};
        stockStarArray.forEach(stockStar=>{
            var market = stockStar.market==2?1:0;
            var key =market==1?"0100"+stockStar.code:"0000"+stockStar.code;
            starLevelMap[key]=stockStar;
            if(stReq.type==0){
                req_array.push({shtSetcode:market,sCode:stockStar.code});
            }else{
               if(stReq.type==stockStar.type){
                   req_array.push({shtSetcode:market,sCode:stockStar.code});
               };
            }

        });
        var stockStarJsonArray=[];
        var stockHqReq = new HQSys.StockHqReq();
        stockHqReq.vStock.readFromObject(req_array);
        prx.stockHq(stockHqReq).then(function(ret){
            var status = ret.response.return;
            if(status===0){
                var vStockHq = ret.response.arguments.stRsp.vStockHq.value;
                vStockHq.forEach(stock=>{
                    var code = stock.shtSetcode==1?'0100'+stock.sCode:'0000'+stock.sCode;
                    var industry =starLevelMap[code].industry;
                    var starLevel =starLevelMap[code].starlevel;

                    var stockStarJson={
                        code:stock.sCode,
                        name:stock.sName,
                        market:stock.shtSetcode,
                        price:stock.stSimHq.fNowPrice,
                        zdf:stock.stSimHq.fChgRatio,
                        industry:industry,
                        starLevel:starLevel
                    };
                    stockStarJsonArray.push(stockStarJson);
                });
                stockStarRsp.iRet=0;
                stockStarRsp.iMsg='SUCCESS';
                stockStarRsp.stockStarList.readFromObject(stockStarJsonArray);
                current.sendResponse(0, stockStarRsp);
                return;
            }else{
                logger.stgyserver.info('getStockStar exception',status);
                stockStarRsp.iRet=-100;
                stockStarRsp.iMsg='请求异常';
                current.sendResponse(-100, stockStarRsp);
                return;
            }
        }, function(err){
            logger.stgyserver.info('getStockStar exception',err);
            stockStarRsp.iRet=-100;
            stockStarRsp.iMsg='请求异常';
            current.sendResponse(-100, stockStarRsp);
            return;
        }).done();

    }catch(e){
        logger.stgyserver.info('getStockStar exception',e);
        stockStarRsp.iRet=-100;
        stockStarRsp.iMsg='请求异常';
        current.sendResponse(-100, stockStarRsp);
        return;
    }

}


Strategy.StrategyInterfImp.prototype.getStockDiagnosis = function (current, stReq, stRsp) {
    logger.stgyserver.info('-------------->Execute getStockDiagnosis');
    var stockDiagnosisRsp = new Strategy.StockDiagnosisRsp();
    try{
        if(!stReq){
            logger.stgyserver.info('getStockDiagnosis no request param');
            stockDiagnosisRsp.iRet=-1;
            stockDiagnosisRsp.iMsg='缺少请求参数';
            current.sendResponse(-1, stockDiagnosisRsp);
            return;
        }
        //股价预测
        var predictMap = global.MarketPredict;
        //近三月个股机构评级
        var stockRating = global.StockRating;
        //九宫格数据
        var stockCalcData = global.StockCalcData;
        //诊股数据
        var diagnosisMap = global.Diagnosis;
        if(predictMap===undefined||stockRating===undefined||stockCalcData===undefined||diagnosisMap===undefined){
            logger.stgyserver.info('getStockDiagnosis no data');
            stockDiagnosisRsp.iRet=0;
            stockDiagnosisRsp.iMsg='请求无数据';
            current.sendResponse(0, stockDiagnosisRsp);
            return;
        }
        var req_array =[{shtSetcode:stReq.market,sCode:stReq.code}];
        var stockHqReq = new HQSys.StockHqReq();
        stockHqReq.vStock.readFromObject(req_array);
        prx.stockHq(stockHqReq).then(function(ret){
            var status = ret.response.return;
            if(status===0){
                var vStockHq = ret.response.arguments.stRsp.vStockHq.value;
                var market=0;
                var name ='';
                var code='';
                var nowPrice=0;
                var zdf = 0;
                var zd=0;
                vStockHq.forEach(stock=>{
                    market=stock.shtSetcode;
                    code=stock.sCode;
                    name = stock.sName;
                    nowPrice=stock.stSimHq.fNowPrice;
                    zdf=stock.stSimHq.fChgRatio;
                    zd=stock.stSimHq.fChgValue;

                });
                var stockMFlowReq = new HQSys.StockMFlowReq();
                stockMFlowReq.market=market;
                stockMFlowReq.sCode=code;
                prx.stockMFlow(stockMFlowReq).then(function(ret){
                        var status = ret.response.return;
                        if(status===0){
                            //股价预测key-------------------
                            var predict_key ='1'+code;
                            if(market==1&&(code=='000001'||code=='000016')){
                                predict_key ='5'+code;
                            }
                            if(code=='399001'||code=='399005'||code==='399006'){
                                predict_key ='5'+code;
                            }
                            if(code=='000300'||code=='399300'){
                                predict_key ='5000300';
                            }

                            var upProb=0,upProb5=0,upProb10=0,upProb20=0;
                            var flucCeil=0,flucCeil5=0,flucCeil10=0,flucCeil20=0;
                            var flucFlor=0,flucFlor5=0,flucFlor10=0,flucFlor20=0;
                            var priceProg=0,priceProg5=0,priceProg10=0,priceProg20=0;
                            var predictJson =eval(predictMap[predict_key]);
                            if(predictJson!=undefined){
                                predictJson.forEach(predict=>{
                                    if(predict.HOLD_RANGE_PAR==1){
                                        upProb=predict.UP_PROB;
                                        flucCeil = predict.FLUC_CEIL;
                                        flucFlor = predict.FLUC_FLOR;
                                        priceProg = predict.PRICE_PROG;
                                    }else if(predict.HOLD_RANGE_PAR==5){
                                        upProb5=predict.UP_PROB;
                                        flucCeil5 = predict.FLUC_CEIL;
                                        flucFlor5 = predict.FLUC_FLOR;
                                        priceProg5 = predict.PRICE_PROG;
                                    }else if(predict.HOLD_RANGE_PAR==6){
                                        upProb10=predict.UP_PROB;
                                        flucCeil10 = predict.FLUC_CEIL;
                                        flucFlor10 = predict.FLUC_FLOR;
                                        priceProg10 = predict.PRICE_PROG;
                                    }else if(predict.HOLD_RANGE_PAR==7){
                                        upProb20=predict.UP_PROB;
                                        flucCeil20 = predict.FLUC_CEIL;
                                        flucFlor20 = predict.FLUC_FLOR;
                                        priceProg20 = predict.PRICE_PROG;
                                    }
                                });
                            }

                            //个股诊断key-------------------
                            var starLevel=0;
                            var shortRec='';
                            var midLongRec='';
                            var priceMacFac='';
                            var priceDisFac='';
                            var amountMacFac='';
                            var amountDisFac='';
                            var financeMacFac='';
                            var financeDisFac='';
                            var valueMacFac='';
                            var valueDisFac='';
                            var dealMacFac='';
                            var dealDisFac='';
                            var  diagnosisKey =market==1?'0100'+code:'0000'+code;
                            var  diagnosisJson =diagnosisMap[diagnosisKey];
                            if(diagnosisJson!=undefined){
                                    starLevel=diagnosisJson.starlevel;
                                    shortRec=diagnosisJson.short_rec;
                                    midLongRec=diagnosisJson.mid_long_rec;
                                    priceMacFac=diagnosisJson.price_mac_fac;
                                    amountMacFac=diagnosisJson.amount_mac_fac;
                                    financeMacFac=diagnosisJson.finance_mac_fac;
                                    valueMacFac=diagnosisJson.value_mac_fac;
                                    dealMacFac=diagnosisJson.deal_mac_fac;

                                    priceDisFac=diagnosisJson.price_dis_fac;
                                    amountDisFac=diagnosisJson.amount_dis_fac;
                                    financeDisFac=diagnosisJson.finance_dis_fac;
                                    valueDisFac=diagnosisJson.value_dis_fac;
                                    dealDisFac=diagnosisJson.deal_dis_fac;
                            }
                            //机构近三月评级数据--------------------------
                            var stockRatingKey =market==1?'01'+code:'00'+code;
                            var ss =0;
                            var bon=0;
                            var ion=0;
                            var non=0;
                            var ron=0;
                            var son=0;
                            var on=0;
                            if(stockRating[stockRatingKey]!=undefined){
                                if(eval(stockRating[stockRatingKey]).length>0){
                                    var ratingJson = eval(stockRating[stockRatingKey])[0];
                                        ss=ratingJson.ss;
                                        bon=ratingJson.bon;
                                        ion=ratingJson.ion;
                                        non=ratingJson.non;
                                        ron=ratingJson.ron;
                                        son=ratingJson.son;
                                        on=ratingJson.on;
                                }


                            }
                            //九宫格数据-------------------------
                            var low_high_key  =market==1?'SH'+code+'_1':'SZ'+code+'_1'; //支撑位 压力位 数据 key
                            var level_key    =market==1?'SH'+code+'_3':'SZ'+code+'_3';  //财务状况等级
                            var deal_key = market==1?'SH'+code+'_4':'SZ'+code+'_4';  //交易状态
                            var trend_key =market==1?'SH'+code+'_5':'SZ'+code+'_5';  //趋势强弱

                            var lowPrice=0;
                            var highPrice=0;

                            if(stockCalcData[low_high_key]!=undefined){
                                var low_high_json= JSON.parse(stockCalcData[low_high_key]);
                                lowPrice=low_high_json[0].f2;
                                highPrice=low_high_json[0].f1;
                            }

                            var level =1;
                            if(stockCalcData[level_key]!=undefined){
                                var level_json =JSON.parse(stockCalcData[level_key]);
                                if(+level_json[0].f2==1){
                                    level=1;
                                }else if(+level_json[0].f3==1){
                                    level=2;
                                }else if(+level_json[0].f4==1){
                                    level=3;
                                }else if(+level_json[0].f5==1){
                                    level=4;
                                }
                            };
                            var todayHot=0;
                            var yesterdayHot=0;
                            var dealStatus=1;

                            if(stockCalcData[deal_key]!=undefined){
                                var deal_json = JSON.parse(stockCalcData[deal_key]);
                                todayHot=+deal_json[0].f1;
                                yesterdayHot=+deal_json[0].f2
                                if(+deal_json[0].f3==1){
                                    dealStatus=1;
                                }else if(+deal_json[0].f4==1){
                                    dealStatus=2;
                                }else if(+deal_json[0].f5==1){
                                    dealStatus=3;
                                }
                            }

                            var trend =0;
                            if(stockCalcData[trend_key]!=undefined){
                                var trend_json =JSON.parse(stockCalcData[trend_key]);
                                trend=trend_json[0].f1;
                            }
                            //资金流向数据
                            var vTickData = ret.response.arguments.stRsp.sttStockMFlow;
                            var zlBuy=vTickData.fSuperIn+vTickData.fBigIn;
                            var zlSell=vTickData.fSuperOut+vTickData.fBigOut;
                            var zlNavBuy=zlBuy-zlSell;

                            var shBuy=vTickData.fMidIn+vTickData.fSmallIn;
                            var shSell=vTickData.fMidOut+vTickData.fSmallOut;
                            var shNavBuy=shBuy-shSell;
                            var zlPer=0;
                            var shPer=0;
                            if((zlBuy+zlSell+shBuy+shSell)!=0){
                                zlPer=zlNavBuy/(zlBuy+zlSell+shBuy+shSell);
                                shPer=shNavBuy/(zlBuy+zlSell+shBuy+shSell);
                            }
                            var predictJson ={
                                upprob:upProb,
                                flucFlor:flucFlor,
                                flucCeil:flucCeil,
                                flucPrice:priceProg,
                                upprob5:upProb5,
                                flucFlor5:flucFlor5,
                                flucCeil5:flucCeil5,
                                flucPrice5:priceProg5,
                                upprob10:upProb10,
                                flucFlor10:flucFlor10,
                                flucCeil10:flucCeil10,
                                flucPrice10:priceProg10,
                                upprob20:upProb20,
                                flucFlor20:flucFlor20,
                                flucCeil20:flucCeil20,
                                flucPrice20:priceProg20
                            }
                            var resultJson ={
                                    code:code,
                                    name:name,
                                    market:market,
                                    price:  nowPrice,
                                    zd:zd,
                                    zdf:zdf,
                                    starLevel:starLevel,
                                    shortRec:shortRec,
                                    midLongRec:midLongRec,

                                    priceMacFac:priceMacFac,
                                    amountMacFac:amountMacFac,
                                    financeMacFac:financeMacFac,
                                    valueMacFac:valueMacFac,
                                    dealMacFac:dealMacFac,

                                    priceDisFac:priceDisFac,
                                    amountDisFac:amountDisFac,
                                    financeDisFac:financeDisFac,
                                    valueDisFac:valueDisFac,
                                    dealDisFac:dealDisFac,

                                    stockPredict:predictJson,

                                    level:level,
                                    todayHot:todayHot,
                                    yesterdayHot:yesterdayHot,
                                    dealStatus:dealStatus,
                                    ss:ss,
                                    bon:bon,
                                    ion:ion,
                                    non:non,
                                    ron:ron,
                                    son:son,
                                    on:on,
                                    zlBuy:zlBuy,
                                    zlSell:zlSell,
                                    zlNavBuy:zlNavBuy,
                                    zlPer:zlPer,
                                    shBuy:shBuy,
                                    shSell:shSell,
                                    shNavBuy:shNavBuy,
                                    shPer:shPer,
                                    lowPrice:lowPrice,
                                    highPrice:highPrice,
                                    trend:trend
                            }
                            stockDiagnosisRsp.iRet=0;
                            stockDiagnosisRsp.iMsg='SUCCESS';
                            stockDiagnosisRsp.stockDiagnosis.readFromObject(resultJson);
                            current.sendResponse(0, stockDiagnosisRsp);
                            return;
                        }else{
                            logger.stgyserver.info('getStockDiagnosis exception',status);
                            stockDiagnosisRsp.iRet=-100;
                            stockDiagnosisRsp.iMsg='请求异常';
                            current.sendResponse(-100, stockDiagnosisRsp);
                            return;
                        }
                    }, function(err){
                        logger.stgyserver.info('getStockDiagnosis exception',err);
                        stockDiagnosisRsp.iRet=-100;
                        stockDiagnosisRsp.iMsg='请求异常';
                        current.sendResponse(-100, stockDiagnosisRsp);
                        return;
                    }
                );
            }else{
                logger.stgyserver.info('getStockDiagnosis exception',status);
                stockDiagnosisRsp.iRet=-100;
                stockDiagnosisRsp.iMsg='请求异常';
                current.sendResponse(-100, stockDiagnosisRsp);
                return;
            }
        }, function(err){
            logger.stgyserver.info('getStockDiagnosis exception',err);
            stockDiagnosisRsp.iRet=-100;
            stockDiagnosisRsp.iMsg='请求异常';
            current.sendResponse(-100, stockDiagnosisRsp);
            return;
        }).done();

    }catch(e){
        logger.stgyserver.info('getStockDiagnosis exception',e);
        stockDiagnosisRsp.iRet=-100;
        stockDiagnosisRsp.iMsg='请求异常';
        current.sendResponse(-100, stockDiagnosisRsp);
        return;
    }
}

